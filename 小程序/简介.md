[参考资料](https://www.jianshu.com/p/fb331438e223)

### 性能优于传统 JS 页面原因

1. JS 单线程，小程序双线程
2. 传统的 DOM 节点有很多属性， 小程序并不是真实的 DOM 节点，也是用 JS 对象去模拟的，没有那么多 DOM 属性
3. 小程序没有浏览器环境

小程序的渲染层和逻辑层分别由两个线程管理：**UI 层使用了 WebView 进行渲染，逻辑层采用了 JSCore 线程运行 JS 脚本。**

逻辑层：创建一个单独的线程去执行 JavaScript，在这个环境下执行的都是有关小程序业务逻辑的代码
渲染层：界面渲染相关的任务全都在 WebView 线程里执行，通过逻辑层代码去控制渲染哪些界面。**一个小程序存在多个界面，所以渲染层存在多个 WebView 线程。**

**逻辑层和渲染层通过消息服务 MessageChannel 进行通信。**

把开发者的 JS 逻辑代码放到单独的线程去运行，但在 Webview 线程里，开发者就没法直接操作 DOM。那要怎么去实现动态更改界面呢？

前面我们知道，逻辑层和渲染层的通信会由 Native （微信客户端）做中转，逻辑层发送网络请求也经由 Native 转发。这是不是意味着，我们可以把 DOM 的更新通过简单的数据通信来实现呢？

**Virtual DOM 相信大家都已有了解，大概是这么个过程：用 JS 对象模拟 DOM 树 -> 比较两棵虚拟 DOM 树的差异 -> 把差异应用到真正的 DOM 树上。**

在渲染层把 WXML 转化成对应的 JS 对象。

在逻辑层发生数据变更的时候，通过宿主环境提供的 setData 方法把数据从逻辑层传递到 Native，再转发到渲染层。

经过对比前后差异，把差异应用在原来的 DOM 树上，更新界面。

| 线程名称   | 所属模块 | 运行代码  | 运行原理            | 说明                                                                                  |
| :--------- | :------- | :-------- | ------------------- | ------------------------------------------------------------------------------------- |
| view       | 渲染层   | WXML/WXSS | WebView 渲染        | wxml 编译器把 wxml 文件转为 js 并构建 virtual dom；wxss 编译器把 wxss 文件转化为 js。 |
| AppService | 逻辑层   | JS        | JavascriptCore 运行 | 无法访问 window / document 对象                                                       |
